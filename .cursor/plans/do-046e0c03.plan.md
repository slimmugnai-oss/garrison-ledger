<!-- 046e0c03-710a-4469-9fcf-4cf71c8f1929 cd1729f5-d8ba-4b23-82a7-0b4c22ad9c55 -->
# Upgrade Page Comprehensive Overhaul

## Overview

Redesign `/dashboard/upgrade` to offer both Premium subscription AND Ask Assistant question packs with a clean, military-professional aesthetic. Fix the Free vs Premium comparison and ensure all Stripe price IDs are properly configured.

## Current Issues

1. **Missing Question Packs**: Only subscription is shown, but question packs exist for Ask Assistant
2. **Incorrect Free vs Premium**: Shows "Calculators: All 6 tools" for both Free and Premium (calculators are actually free)
3. **Missing Price IDs**: Environment variables for question packs and annual subscription not set
4. **Outdated Benefits**: Doesn't mention Ask Assistant credits (5 free, 50 premium)
5. **No Annual Toggle**: Annual option hidden as small text instead of prominent toggle

## Product Information

### Premium Subscription

- **Monthly**: $9.99/month (price_1SHdWQQnBqVFfU8hW2UE3je8)
- **Annual**: $99/year (price_1SHdWpQnBqVFfU8hPGQ3hLqK)
- **Product ID**: prod_TE5hK7gmtxzx1R

### Ask Assistant Question Packs

- **25 questions**: $1.99 (price_1SLShbQnBqVFfU8hmlMX4OAw, prod_TI2nU6NbiSqE3u)
- **100 questions**: $5.99 (price_1SLSjiQnBqVFfU8hQM482yKn, prod_TI2pfWg3kcUG3l)
- **250 questions**: $9.99 (price_1SLSkfQnBqVFfU8hYGhP4kXE, prod_TI2qsCEXsNzfvS)

## Implementation Plan

### 1. Update Environment Variables

Add missing Stripe price IDs to Vercel:

```
STRIPE_PREMIUM_MONTHLY_PRICE_ID=price_1SHdWQQnBqVFfU8hW2UE3je8
STRIPE_PREMIUM_ANNUAL_PRICE_ID=price_1SHdWpQnBqVFfU8hPGQ3hLqK
STRIPE_QUESTION_PACK_25_PRICE_ID=price_1SLShbQnBqVFfU8hmlMX4OAw
STRIPE_QUESTION_PACK_100_PRICE_ID=price_1SLSjiQnBqVFfU8hQM482yKn
STRIPE_QUESTION_PACK_250_PRICE_ID=price_1SLSkfQnBqVFfU8hYGhP4kXE
```

### 2. Update SSOT (Single Source of Truth)

File: `lib/ssot.ts`

Add pricing information to the SSOT module:

```typescript
pricing: {
  subscription: {
    monthly: {
      priceUSD: 9.99,
      priceId: process.env.STRIPE_PREMIUM_MONTHLY_PRICE_ID || '',
      productId: 'prod_TE5hK7gmtxzx1R'
    },
    annual: {
      priceUSD: 99,
      priceId: process.env.STRIPE_PREMIUM_ANNUAL_PRICE_ID || '',
      productId: 'prod_TE5hK7gmtxzx1R',
      savings: 20 // $99 vs $119.88
    }
  },
  questionPacks: {
    pack25: {
      questions: 25,
      priceUSD: 1.99,
      priceId: process.env.STRIPE_QUESTION_PACK_25_PRICE_ID || '',
      productId: 'prod_TI2nU6NbiSqE3u',
      perQuestionCost: 0.0796
    },
    pack100: {
      questions: 100,
      priceUSD: 5.99,
      priceId: process.env.STRIPE_QUESTION_PACK_100_PRICE_ID || '',
      productId: 'prod_TI2pfWg3kcUG3l',
      perQuestionCost: 0.0599
    },
    pack250: {
      questions: 250,
      priceUSD: 9.99,
      priceId: process.env.STRIPE_QUESTION_PACK_250_PRICE_ID || '',
      productId: 'prod_TI2qsCEXsNzfvS',
      perQuestionCost: 0.03996
    }
  }
}
```

### 3. Redesign Upgrade Page

File: `app/dashboard/upgrade/page.tsx`

**New Structure:**

```
┌─────────────────────────────────────────┐
│ Hero Section                            │
│ - "Upgrade to Premium"                  │
│ - "Or buy question credits"             │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ Premium Subscription (Primary)          │
│ ┌───────────┬───────────┐              │
│ │ $9.99/mo  │ $99/year  │ ← Toggle     │
│ └───────────┴───────────┘              │
│ ✓ Unlimited LES Audits                  │
│ ✓ Full Base Navigator (all results)     │
│ ✓ Unlimited TDY Receipts                │
│ ✓ 50 Ask Assistant questions/month      │
│ ✓ Premium Intel Cards                   │
│ [Upgrade to Premium - $9.99/month]      │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ Ask Assistant Question Packs            │
│ (One-time purchase)                     │
│ ┌──────┬──────┬──────┐                 │
│ │  25  │ 100  │ 250  │                 │
│ │$1.99 │$5.99 │$9.99 │                 │
│ └──────┴──────┴──────┘                 │
│ Perfect for occasional questions        │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ Free vs Premium Comparison              │
│ (Fixed table with accurate info)        │
└─────────────────────────────────────────┘
```

**Key Changes:**

1. **Monthly/Annual Toggle**: Use state to switch between monthly and annual pricing
2. **Question Packs Section**: New section below subscription with 3 cards
3. **Updated Benefits**: Include Ask Assistant credits (5 free, 50 premium)
4. **Fixed Comparison**: Calculators are FREE for both tiers
5. **Better CTAs**: Clear action buttons for each option

### 4. Fix Free vs Premium Comparison Table

**Correct comparison:**

| Feature | Free | Premium |

|---------|------|---------|

| **LES Audits** | 1/month | Unlimited |

| **Base Navigator** | Top 3 results | Full rankings |

| **TDY Receipts** | 3 per trip | Unlimited |

| **Ask Assistant** | 5 questions/month | 50 questions/month |

| **Binder Storage** | 1 GB | 5 GB |

| **Intel Library** | Basic cards | All premium cards |

| **Calculators** | ✅ All 6 tools | ✅ All 6 tools |

### 5. Update Stripe Checkout API

File: `app/api/stripe/create-checkout-session/route.ts`

Currently only handles subscriptions. Update to handle both:

1. **Subscription mode**: `mode: 'subscription'` (existing)
2. **Payment mode**: `mode: 'payment'` for one-time question packs

Add logic to determine mode based on price ID:

```typescript
// Determine checkout mode based on price ID
const isSubscription = priceId.includes('price_1SHd'); // Subscription price IDs
const mode = isSubscription ? 'subscription' : 'payment';

const session = await stripe.checkout.sessions.create({
  customer_email: user.emailAddresses[0]?.emailAddress,
  line_items: [{ price: priceId, quantity: 1 }],
  mode, // Dynamic mode
  // ... rest of config
});
```

### 6. Update Webhook Handler

File: `app/api/stripe/webhook/route.ts`

Add handler for question pack purchases:

```typescript
case 'checkout.session.completed':
  // Check if payment (question pack) vs subscription
  if (session.mode === 'payment') {
    // Add credits to ask_credits table
    const priceId = session.line_items[0].price.id;
    const credits = getCreditsForPriceId(priceId); // 25, 100, or 250
    
    await supabase.from('ask_credits').update({
      credits_remaining: credits_remaining + credits,
      credits_total: credits_total + credits
    }).eq('user_id', metadata.userId);
  }
```

### 7. Create QuestionPackCard Component

File: `app/components/QuestionPackCard.tsx`

Reusable component for question pack options:

```tsx
interface QuestionPackCardProps {
  questions: number;
  price: number;
  priceId: string;
  perQuestionCost: number;
  mostPopular?: boolean;
}

export default function QuestionPackCard({ 
  questions, 
  price, 
  priceId,
  perQuestionCost,
  mostPopular 
}: QuestionPackCardProps) {
  return (
    <div className={`relative rounded-lg border-2 p-6 ${mostPopular ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white'}`}>
      {mostPopular && (
        <Badge className="absolute -top-3 left-1/2 -translate-x-1/2">
          Best Value
        </Badge>
      )}
      <div className="text-center mb-4">
        <div className="text-4xl font-bold text-gray-900">{questions}</div>
        <div className="text-sm text-gray-600">questions</div>
      </div>
      <div className="text-center mb-4">
        <div className="text-3xl font-bold text-gray-900">${price}</div>
        <div className="text-sm text-gray-500">{(perQuestionCost * 100).toFixed(1)}¢ per question</div>
      </div>
      <PaymentButton
        priceId={priceId}
        buttonText="Buy Now"
        className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
      />
    </div>
  );
}
```

### 8. Add Billing Period Toggle Component

File: `app/components/BillingPeriodToggle.tsx`

Toggle between monthly and annual:

```tsx
'use client';

interface BillingPeriodToggleProps {
  period: 'monthly' | 'annual';
  onChange: (period: 'monthly' | 'annual') => void;
}

export default function BillingPeriodToggle({ period, onChange }: BillingPeriodToggleProps) {
  return (
    <div className="flex items-center justify-center gap-3 mb-6">
      <button
        onClick={() => onChange('monthly')}
        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${
          period === 'monthly' 
            ? 'bg-blue-600 text-white' 
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
        }`}
      >
        Monthly
      </button>
      <button
        onClick={() => onChange('annual')}
        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${
          period === 'annual' 
            ? 'bg-blue-600 text-white' 
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
        }`}
      >
        Annual
        <span className="ml-2 text-xs bg-green-500 text-white px-2 py-0.5 rounded">
          Save $20
        </span>
      </button>
    </div>
  );
}
```

## Files to Modify

1. `lib/ssot.ts` - Add pricing configuration
2. `app/dashboard/upgrade/page.tsx` - Complete redesign
3. `app/api/stripe/create-checkout-session/route.ts` - Support payment mode
4. `app/api/stripe/webhook/route.ts` - Handle question pack purchases
5. `app/components/QuestionPackCard.tsx` - NEW component
6. `app/components/BillingPeriodToggle.tsx` - NEW component

## Testing Checklist

- [ ] Monthly subscription checkout works
- [ ] Annual subscription checkout works
- [ ] All 3 question pack checkouts work
- [ ] Webhook adds credits for question pack purchases
- [ ] Free vs Premium table shows correct information
- [ ] Mobile responsive on all screen sizes
- [ ] Already-premium users see manage subscription UI
- [ ] Environment variables all set in Vercel

## Success Criteria

1. Users can purchase premium subscription (monthly or annual)
2. Users can purchase question packs for Ask Assistant
3. Free vs Premium comparison is accurate
4. UI is clean, sophisticated, and military-professional
5. All Stripe integrations working correctly
6. Mobile responsive and accessible

### To-dos

- [ ] Configure Cloudflare DNS records for garrisonledger.com pointing to Vercel
- [ ] Add garrisonledger.com and www subdomain to Vercel project
- [ ] Update Clerk allowed origins and redirect URLs to new domain
- [ ] Create new Stripe webhook for garrisonledger.com and update secret
- [ ] Update Supabase site URL and auth redirect URLs
- [ ] Update Google Cloud Console authorized origins for all APIs
- [ ] Update NEXT_PUBLIC_SITE_URL and NEXT_PUBLIC_APP_URL in Vercel environments
- [ ] Update seo-config.ts, email-templates.tsx, and all email components with new domain
- [ ] Update documentation files with new domain references
- [ ] Complete full testing checklist on garrisonledger.com
- [ ] Remove old domain from Vercel and external services after successful testing